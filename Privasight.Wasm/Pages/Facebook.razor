@page "/facebook"
@using Privasight.Model.Shared.Interfaces
@using Privasight.Wasm.CardComponents.NumberCards.Base
@using Privasight.Wasm.Services
@using Privasight.Model.Shared
@using Privasight.Model.Shared.AbstractClasses
@using Privasight.Wasm.CardComponents.NumberCards
@using Privasight.Wasm.CardComponents.Tables

@inject DialogService _dialogService
@inject DataService _dataService

<PageTitle>Facebook Data</PageTitle>
<h1>Your Facebook Data</h1>

<div class="row">
	<div class=@_colStr>
		<NumberCardWithLineChart OnClickFunc="() => Task.CompletedTask"/>
	</div>
	@if (_dataService.FbRoot?.AvailableData.Values != null)
	{
		foreach (var wrapper in _dataService.FbRoot.AvailableData.Values)
		{
			switch (wrapper)
			{
				case ISingleItemListFile<StringWrapperDbObj> stringList:
					_singleStringList = stringList;
					<div class="@_colStr">
						@NumberCardWithDataListTableDialogInstance
					</div>
					break;

				case ISingleItemListFile itemList:
					_singleItemListFile = itemList;
					<div class=@_colStr>
						@NumberCardWithSingleItemListTableDialogInstance
					</div>
					break;
			}
		}
	}
</div>

@code {
	const int ColNumber = 3;
	string _colStr => $"col-md-{12/ColNumber}";

	ISingleItemListFile _singleItemListFile = null!;
	ISingleItemListFile _singleStringList = null!;

	RenderFragment NumberCardWithSingleItemListTableDialogInstance => builder =>
	{
		var t = SingleItemListFileHelper.GetItemsT(_singleItemListFile);
		var type = typeof(NumberCardWithTableDialog<>).MakeGenericType(t);
		builder.OpenComponent(1, type);
		builder.AddAttribute(2,nameof(NumberCardWithTableDialog<DbTableObj>.SingleItemListFile), _singleItemListFile);
		builder.AddAttribute(3, nameof(NumberCardWithTableDialog<DbTableObj>.ChosenTable), AvailableTables.DetailedTable);
		builder.CloseComponent();
	};

	RenderFragment NumberCardWithDataListTableDialogInstance => builder =>
	{
		var t = SingleItemListFileHelper.GetItemsT(_singleStringList);
		var type = typeof(NumberCardWithTableDialog<>).MakeGenericType(t);
		builder.OpenComponent(1, type);
		builder.AddAttribute(2,nameof(NumberCardWithTableDialog<DbTableObj>.SingleItemListFile), _singleStringList);
		builder.AddAttribute(3, nameof(NumberCardWithTableDialog<DbTableObj>.ChosenTable), AvailableTables.DataList);
		builder.AddAttribute(4, nameof(NumberCardWithTableDialog<DbTableObj>.DisplayPropertyName), nameof(StringWrapperDbObj.StrVal));
		builder.CloseComponent();
	};

	protected override async Task OnInitializedAsync()
	{
		if (_dataService.FbRoot == null)
		{
			await _dataService.SetFbRootFromStorage();
		}
	}
}
